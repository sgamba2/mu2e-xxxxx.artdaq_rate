% -*- mode:flyspell; mode:latex -*-
\documentclass[12pt]{article}

% \addtolength{\oddsidemargin} {-0.885in}
% \addtolength{\textwidth}{1.75in}
% \addtolength{\evensidemargin}{-0.8in}
% topmargin -0.5in
\usepackage[a4paper, top=1cm, left=1.5cm, right=1.5cm]{geometry} % width= , 

\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{float}


\usepackage{tikz}
\usepackage{[caption}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations.markings}
%\usepackage{lineno}

\usetikzlibrary{decorations.pathmorphing}
% \usepackage[absolute,overlay]{textpos}
% \usepackage{onimage}

\usepackage{times}
\usepackage{graphics}

% \usepackage{subfigure}
% \usepackage{scalefnt}
%
% \renewcommand\thesubfigure{\arabic{subfigure}}

\usepackage{amsmath}
\usepackage{hyperref}
\usepackage{hhline}
\usepackage{subfig}
\usepackage{color}
\usepackage[all]{hypcap}

\usepackage[normalem]{ulem}  % for striking out
% \usepackage{fancyhdr}
% \pagestyle{fancy}
% \fancyhead[C]{}
% \fancyhead[L] {\it{Mu2e-doc-29670-v1.0} }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% use natbib - biblatex not available on Mu2e interactive nodes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[square,sort,comma,numbers]{natbib}

% location of the .bib files: env var BIBINPUTS (~/library/bibliography)

% \usepackage[backend=biber, style=numeric-comp, sorting=ynt] {biblatex}
% \addbibresource{clfv.bib}

% \addbibresource{stntuple.bib}
% \addbibresource{mu2e_web.bib}
% \addbibresource{radiative_pion_capture.bib}

\graphicspath{{figures/}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% for portability, make sure all commands are included locally
% order them alphabetically
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \include{commands}

\newcommand {\keVc}       {\mbox{$\rm keV\!/\!c$}}
\newcommand {\kmax}       {\mbox{$k_{\rm max}$}}

\newcommand {\MeVc}       {\mbox{$\rm MeV\!/c$}}
\newcommand {\MeVcsq}     {\mbox{$\rm MeV\!/c^2$}}

\newcommand {\mumemconv}[1][A] {\mbox{$\mu^- \textrm{#1} \rightarrow e^- \textrm{#1}$}}
% Define a relay to have 2 default arguments instead of limit of 1
\newcommand {\mumepconv}[1][A] {%
  \def\ArgI{{#1}}%store the first argument
  \mumepconvRelay
}
\newcommand \mumepconvRelay[1][A]  {\mbox{$\mu^- \textrm{\ArgI} \rightarrow e^+ \textrm{#1}$}}
\newcommand {\muminus}    {\mbox{$\mu^-$}}
\newcommand {\muplus}    {\mbox{$\mu^+$}}
\newcommand {\MuToEm}     {\mbox{$\mu^- \ra e^-$}}
\newcommand {\MuToEp}     {\mbox{$\mu^- \ra e^+$}}
\newcommand {\MuPToEp}    {\mbox{$\mu^+ \ra e^+$}}
\newcommand {\ra}        {\rightarrow}
\newcommand {\tandip}    {\mbox{$\tan \lambda$}}

\newcommand {\Pb}[1]     {\mbox{$\rm ^{#1}Pb$}}                 % isotopes of lead
\newcommand {\Au}[1]     {\mbox{$\rm ^{#1}Au$}}                 % isotopes of gold
\newcommand {\Ir}[1]     {\mbox{$\rm ^{#1}Ir$}}                 % isotopes of iridium
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% editing commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand {\add}[1]    {{\red #1}}
\newcommand {\alt}[1]    {{\green #1}} %alternate comment color
\newcommand {\del}[1]    {{\blue \sout{#1}}}
\newcommand {\dlt}[1]    {{\violet \sout{#1}}} %alternate delete color

\newcommand {\black}     {\color{black}}
\newcommand {\red}       {\color{red}}
\newcommand {\blue}      {\color{blue}}
\newcommand {\strike}[1] {{\blue \sout{#1}}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\begin{titlepage}
  \begin{flushright}
    \bf {MU2E/PHYSICS/xxxxx} \\
    version 1.0
    \today
 \end{flushright}

  \vspace{1cm}

  \begin{center}
    {\Large \bf Commissioning of the Mu2e Data AcQuisition system and the Vertical Slice Test of the straw tracker

      \vspace{0.3in}

      11. An artdaq Demo tests
    }

    \vspace{1cm}
    Pavel Murat (FNAL) \\
    Sara Gamba (University of Pisa)
%     S. Gamba  \footnote{\texttt{Fermilab; e-mail:s.gamba2\@studenti.unipi.it} (University of Pisa)
%     P. Murat \footnote{\texttt{Fermilab; e-mail: murat\@fnal.gov}

   
    version 1.0
    \today
 \end{center}

  \begin{abstract}
    This note presents the initial results of a simulation conducted with an artdaq demo.
    \vspace{0.2in}
  \end{abstract}

\end{titlepage}
% \frontmatter
% \chapter*{Abstract}
%
% \addcontentsline{toc}{chapter}{Abstract}
%
% \mainmatter
%
{\tableofcontents}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\chapter{Calibration}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \input{input_data}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage

\section {Notes for the authors}
\subsection {Revision history} 
\begin{itemize}
\item
  v1.01: initial version
\end{itemize}
\newpage
\section{Running an artdaq demo}
We are running an artdaq demo simulation to test if the artdaq supports high event rates: we should be able to read data at a rate on average 2 kHz per boardreader. The demo uses two boardreaders, both on the same computer, two eventbuilders and a common datalogger. We are sending some random events to two boardreaders. An event is composed of an header and of some fragments, each of 2 bytes. We can decide the number of fragments, changing a variable called $nADCchannels$ and as a consequence, we change the event size (header size is fixed). The boardreaders communicate with the eventbuilders through the shared memory. A dispatcher, which aggregates DQM metrics and presents them to a visualizer application, is also used. Events are generated with a frequency that is the inverse of a variable called $throttle\_ usecs$, expressed in $\mu$s. We are testing the system, changing $nADCchannels$ and $throttle\_usecs$. We are testing also changing the boardreaders or eventbuilders number and switching off the dispatcher. MIDAS slow control monitoring system provides tracking of the output file size and the input frequency of data in a boardreader.
\section{Results}
I would like to report in advance all type of errors seen during the runs and after that for which parameters these errors occur. The errors, reported in the log files, are the following:
\begin{itemize}
    \item \textit{Bad Omen: Data Buffer has exceeded its size limits}.
    \\
    \textit{($seq\_id$=125, $frag\_id$=0, frags=1001/1000, szB=200248048/1048576000), timestamps=124-1124}
    \\
    While this type of error occurs, the input rate in the first boardreader becomes unstable;
    \item \textit{Back-pressure condition: All Shared Memory buffers have been full for 12.025 s!}
    \\
    While this type of error occurs, no data are written on the output file.
\end{itemize}
In the following, different tables are reported, showing all parameters changed during the runs. In each table number of bytes generated, generation frequency and the result of the run are shown. The result could be either the error we are getting or the first boardreader rate reported by the system. The errors generally occur as soon as the run as started. If not, I reported the time after which the error occurs.
\begin{center}  
\begin{table}[!h]
\centering
\begin{tabular}{c c c}
\hline
bytes & throttle\_usecs &  result\\
\hline
200k & 0 & BAD OMEN \& back pressure \\
200k & 10 (100kHz) & BAD OMEN \& back pressure \\
200k & 100 (10kHz) & BAD OMEN \& back pressure\\
200k & 1000 (1kHz) & BAD OMEN \& back pressure \\
200k & 10000 (100Hz) & BAD OMEN \& back pressure \\
200k & 100000 (10Hz) & BAD OMEN \& back pressure\\
\end{tabular}
\caption{This table show the results of data run with events of 200kB at different generation frequency. As we can see, it is not possible to operate with this event size.}
\end{table}\label{tab:upperlimits}
\end{center}
\begin{center}  
\begin{table}[!h]
\centering
\begin{tabular}{c c c}
\hline
bytes & throttle\_usecs &  result\\
\hline
100k & 1000 (1kHz) & BAD OMEN \\
100k & 2000 (500Hz) & BAD OMEN \\
100k & 4000 (250Hz) & BAD OMEN \\
100k & 5000 (200Hz) & BAD OMEN \\
100k & 6000 (166Hz) & OKAY: rate 163Hz \\
100k & 10000 (100Hz) & OKAY: rate 98.5Hz \\
\end{tabular}
\caption{This table show the results of data run with events of 100kB at different generation frequency. At more or less 20MB/s the system gets errors. It is possible to operate only under 200 Hz per boardreader with an event size of 100kB.}
\end{table}\label{tab:upperlimits}
\end{center}

\begin{center}  
\begin{table}[!h]
\centering
\begin{tabular}{c c c}
\hline
bytes & throttle\_usecs &  result\\
\hline
70k & 3000 (333Hz) & BAD OMEN  \\

70k & 4000 (250Hz) & BAD OMEN after 1 m  \\

70k & 5000 (200Hz) & OKAY: rate 195Hz  \\
\end{tabular}
\caption{This table show the results of data run with events of 70kB at different generation frequency. At more or less 20MB/s the system gets errors. It is possible to operate only under 195 Hz per boardreader with an event size of 70kB.}
\end{table}\label{tab:upperlimits}
\end{center}

\begin{center}  
\begin{table}[!h]
\centering
\begin{tabular}{c c c}
\hline
bytes & throttle\_usecs &  result\\
\hline
40k & 2000 (500Hz) & BAD OMEN  \\
40k & 3000 (333Hz) & OKAY: rate 320Hz  \\
40k & 5000 (200Hz) & OKAY: rate 195Hz  \\
40k & 10000 (100Hz) & OKAY: rate 98.7Hz \\
\end{tabular}
\caption{This table show the results of data run with events of 40kB at different generation frequency. At more or less 20MB/s the system gets errors. It is possible to operate only under 320 Hz per boardreader with an event size of 40kB.}
\end{table}\label{tab:upperlimits}
\end{center}
\section{Conclusions}
No significant change has been seen changing the number of boardreaders and eventbuilders and also without the dispatcher.
In conclusion, we have tested that it is not possible to run artdaq at rates higher than 300Hz per boardreader and this needs to be fixed. 

\end{document}

